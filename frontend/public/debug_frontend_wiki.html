<!DOCTYPE html>
<html>
<head>
    <title>Wiki çŠ¶æ€è°ƒè¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” Wiki çŠ¶æ€è°ƒè¯•å·¥å…·</h1>

    <h2>æµ‹è¯• 1: å•ä¸ªé¡¹ç›®æŸ¥è¯¢</h2>
    <button onclick="testSingleProject()">æŸ¥è¯¢ token_board</button>
    <pre id="single-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</pre>

    <h2>æµ‹è¯• 2: æ‰¹é‡æŸ¥è¯¢</h2>
    <button onclick="testBatchQuery()">æ‰¹é‡æŸ¥è¯¢</button>
    <pre id="batch-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</pre>

    <h2>æµ‹è¯• 3: é¡¹ç›® Key æ„å»º</h2>
    <button onclick="testProjectKey()">æµ‹è¯•é¡¹ç›® Key</button>
    <pre id="key-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</pre>

    <script>
        async function testSingleProject() {
            const result = document.getElementById('single-result');
            result.innerHTML = 'â³ æŸ¥è¯¢ä¸­...';

            try {
                const projectKey = 'gitlab:konghaifeng/token_board';
                const url = `/api/wiki/projects/${encodeURIComponent(projectKey)}/status`;

                result.innerHTML += `\nğŸ“¤ è¯·æ±‚: GET ${url}`;

                const response = await fetch(url);
                const data = await response.json();

                result.innerHTML = `
âœ… æˆåŠŸï¼

è¯·æ±‚ URL: ${url}
çŠ¶æ€ç : ${response.status}

å“åº”æ•°æ®:
${JSON.stringify(data, null, 2)}
                `;
                result.className = 'success';
            } catch (err) {
                result.innerHTML = `âŒ å¤±è´¥: ${err.message}`;
                result.className = 'error';
            }
        }

        async function testBatchQuery() {
            const result = document.getElementById('batch-result');
            result.innerHTML = 'â³ æŸ¥è¯¢ä¸­...';

            try {
                const projectKeys = [
                    'gitlab:konghaifeng/token_board',
                    'gitlab:test/project'
                ];

                result.innerHTML += `\nğŸ“¤ æŸ¥è¯¢é¡¹ç›®: ${projectKeys.join(', ')}`;

                const response = await fetch('/api/wiki/projects/status/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_keys: projectKeys })
                });

                const data = await response.json();

                result.innerHTML = `
âœ… æˆåŠŸï¼

çŠ¶æ€ç : ${response.status}

å“åº”æ•°æ®:
${JSON.stringify(data, null, 2)}

token_board çŠ¶æ€: ${data['gitlab:konghaifeng/token_board']?.status || 'æœªæ‰¾åˆ°'}
                `;
                result.className = 'success';
            } catch (err) {
                result.innerHTML = `âŒ å¤±è´¥: ${err.message}`;
                result.className = 'error';
            }
        }

        async function testProjectKey() {
            const result = document.getElementById('key-result');

            // æ¨¡æ‹Ÿé¡¹ç›®æ•°æ®
            const mockProject = {
                id: 123,
                name: 'token_board',
                path: 'token_board',
                path_with_namespace: 'konghaifeng/token_board'
            };

            const namespace = mockProject.path_with_namespace.split('/')[0];
            const repoName = mockProject.path;
            const projectKey = `gitlab:${namespace}/${repoName}`;

            result.innerHTML = `
ğŸ“‹ é¡¹ç›®ä¿¡æ¯:
  name: ${mockProject.name}
  path: ${mockProject.path}
  path_with_namespace: ${mockProject.path_with_namespace}

ğŸ”‘ æ„å»ºçš„ Project Key:
  namespace: ${namespace}
  repoName: ${repoName}
  projectKey: ${projectKey}

âœ… åº”è¯¥åŒ¹é…æ•°æ®åº“ä¸­çš„ key: gitlab:konghaifeng/token_board
            `;
            result.className = 'info';
        }
    </script>
</body>
</html>
